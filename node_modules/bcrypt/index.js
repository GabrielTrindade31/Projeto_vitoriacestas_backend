// Lightweight bcrypt-compatible facade built with Node's crypto API.
// This fallback exists because native bcrypt binaries cannot be installed in the sandboxed environment.
// The API mirrors the subset used by the project: hashSync, compare (async) e compareSync.
const crypto = require('crypto');

function derive(password, salt, rounds) {
  return crypto.pbkdf2Sync(password, salt, Math.max(1, rounds) * 1000, 64, 'sha512').toString('hex');
}

function hashSync(password, rounds = 10) {
  const salt = crypto.randomBytes(16).toString('hex');
  const digest = derive(password, salt, rounds);
  return `$simplebcrypt$${rounds}$${salt}$${digest}`;
}

function compareSync(password, hashed) {
  const parts = hashed.split('$');
  if (parts.length < 4) return false;
  const rounds = Number(parts[2]);
  const salt = parts[3];
  const digest = derive(password, salt, rounds);
  return digest === parts[4];
}

function compare(password, hashed) {
  return Promise.resolve(compareSync(password, hashed));
}

module.exports = { hashSync, compare, compareSync };
